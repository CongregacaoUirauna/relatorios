<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Assistência</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f9f9f9;
        }
        .container {
            max-width: 500px;
        }
    </style>
</head>
<body>
    <div class="container p-4 my-5 bg-white rounded shadow-sm border">
        <h2 class="text-center mb-4">Relatório de Assistência</h2>
        
        <form id="assistenciaForm">
            <div class="mb-3">
                <label for="tipoReuniao" class="form-label fs-5">Tipo de Reunião:</label>
                <select id="tipoReuniao" class="form-select form-select-lg" required>
                    <option value="">Selecione...</option>
                    <option value="Meio de Semana">Meio de Semana</option>
                    <option value="Fim de Semana">Fim de Semana</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="dataReuniao" class="form-label fs-5">Data da Reunião:</label>
                <input type="date" id="dataReuniao" class="form-control form-control-lg" required>
            </div>

            <div class="mb-3">
                <label for="quantidade" class="form-label fs-5">Quantidade de Presentes:</label>
                <input type="number" id="quantidade" class="form-control form-control-lg" min="0" step="1" required>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" id="submitButton" class="btn btn-success btn-lg w-100 mt-3">
                    <span id="submitButtonText">Enviar Assistência</span>
                    <div id="submitSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;">
                        <span class="visually-hidden">Enviando...</span>
                    </div>
                </button>
            </div>

            <div id="formSuccess" class="alert alert-success mt-3" style="display: none;"></div>
            <div id="formError" class="alert alert-danger mt-3" style="display: none;"></div>
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // [PRODUÇÃO V2] JS (reuniao.html)

        // --- 1. Configuração do Firebase ---
        // [OBRIGATÓRIO] Substitua pela configuração do seu projeto Firebase
        const firebaseConfig = {
            apiKey: "SEU_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const reunioesCol = db.collection("reunioes");

        // --- 2. Elementos do DOM ---
        const form = document.getElementById("assistenciaForm");
        const submitButton = document.getElementById("submitButton");
        const submitButtonText = document.getElementById("submitButtonText");
        const submitSpinner = document.getElementById("submitSpinner");
        const formSuccess = document.getElementById("formSuccess");
        const formError = document.getElementById("formError");

        // --- 3. Lógica de Envio ---
        async function handleFormSubmit(e) {
            e.preventDefault(); // Impede o recarregamento da página
            
            // UI de carregamento
            setLoading(true);
            formSuccess.style.display = "none";
            formError.style.display = "none";

            // Coleta de dados
            const tipo = document.getElementById("tipoReuniao").value;
            const dataString = document.getElementById("dataReuniao").value; // Formato: "YYYY-MM-DD"
            const quantidade = Number(document.getElementById("quantidade").value);

            // Validação simples
            if (!tipo || !dataString || !quantidade) {
                formError.textContent = "Por favor, preencha todos os campos.";
                formError.style.display = "block";
                setLoading(false);
                return;
            }

            // --- Ponto Crítico: Conversão de Data ---
            // O <input type="date"> retorna uma string "YYYY-MM-DD".
            // O JS a interpreta como hora local (meia-noite na sua zona).
            // Para evitar problemas de fuso horário, anexamos "T00:00:00"
            // para forçar a interpretação no fuso local correto.
            const dataObjeto = new Date(`${dataString}T00:00:00`);
            
            // Converte o objeto Date do JS para um Timestamp do Firebase.
            const dataTimestamp = firebase.firestore.Timestamp.fromDate(dataObjeto);
            
            // Salva a data também como string (DD/MM/YYYY) para fácil leitura no dashboard.
            const dataFormatada = dataObjeto.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                timeZone: 'UTC' // Usamos UTC aqui pois a data já está corrigida
            });

            const relatorio = {
                tipo: tipo,
                data: dataFormatada, // Ex: "28/10/2025" (para leitura)
                quantidade: quantidade,
                dataTimestamp: dataTimestamp // Ex: Timestamp(seconds=...,) (para consulta/filtro)
            };

            try {
                // Salva na coleção 'reunioes'
                await reunioesCol.add(relatorio);

                // Sucesso
                formSuccess.textContent = "Relatório de assistência enviado com sucesso!";
                formSuccess.style.display = "block";
                form.reset(); // Limpa o formulário

            } catch (error) {
                console.error("Erro ao enviar relatório de assistência: ", error);
                formError.textContent = "Ocorreu um erro ao enviar seu relatório. Por favor, tente novamente.";
                formError.style.display = "block";
            } finally {
                // Para a UI de carregamento
                setLoading(false);
            }
        }

        // Função utilitária para controlar o estado do botão
        function setLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                submitButtonText.textContent = "Enviando...";
                submitSpinner.style.display = "inline-block";
            } else {
                submitButton.disabled = false;
                submitButtonText.textContent = "Enviar Assistência";
                submitSpinner.style.display = "none";
            }
        }

        // --- 4. Inicialização ---
        document.addEventListener("DOMContentLoaded", () => {
            form.addEventListener("submit", handleFormSubmit);
            
            // Define a data de hoje como padrão no <input type="date">
            // Formato YYYY-MM-DD
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0'); // +1 pois mês é 0-11
            const dia = String(hoje.getDate()).padStart(2, '0');
            document.getElementById('dataReuniao').value = `${ano}-${mes}-${dia}`;
        });
    </script>
</body>
</html>
