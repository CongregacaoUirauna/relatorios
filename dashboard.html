<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - V2.3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body {
            /* [V2.3] Fundo suave padrão do Bootstrap */
            background-color: #f8f9fa;
        }

        /* --- Estilo dos Cards de Total --- */
        .card-total {
            text-align: center;
        }
        .card-total .display-6 {
            font-weight: 600;
        }
        .card-total small {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
        }

        /* --- CSS para a Edição de Nome (Feature V2) --- */
        .nome-input { display: none; }
        .nome-text.editing { display: none; }
        .nome-text.editing + .nome-input { display: inline-block; width: 70%; }
        .edit-buttons { display: none; }
        .default-buttons.editing { display: none; }
        .edit-buttons.editing { display: inline-flex; gap: 5px; }
        
        /* --- Estilo para a nova tabela de relatórios --- */
        .table-reports { font-size: 0.9rem; }
        .table-reports th { font-weight: 600; }

        /* [V2.3] Estilo para as Abas Principais (Design Suave) */
        .main-task-tabs .nav-link {
            font-size: 1.15rem;
            padding-top: 0.8rem;
            padding-bottom: 0.8rem;
            color: #6c757d; /* Cinza suave para abas inativas */
            border: 0;
            border-bottom: 3px solid transparent;
        }
        .main-task-tabs .nav-link.active {
            color: #0d6efd; /* Cor primária */
            font-weight: 500;
            background-color: transparent;
            border-bottom: 3px solid #0d6efd;
        }
        .main-task-tabs .nav-link:hover {
            color: #0d6efd;
            border-bottom: 3px solid #dee2e6;
        }
        
    </style>
</head>
<body>

    <div id="loginContainer" class="container" style="max-width: 450px; margin-top: 15vh;">
        <div class="card p-4 shadow-sm border-0">
            <h3 class="text-center mb-4">Acesso Restrito</h3>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
            </form>
            <a href="#" id="forgotPasswordLink" class="text-center mt-3 d-block">Esqueceu a senha?</a>
            <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
            <div id="loginSuccess" class="alert alert-success mt-3" style="display: none;"></div>
        </div>
    </div>

    <div id="dashboardContainer" style="display: none;">
        
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Painel Admin V2.3</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarMain">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <span class="navbar-text" id="userEmail"></span>
                        </li>
                    </ul>
                    <button id="logoutButton" class="btn btn-danger btn-sm">
                        <i class="bi bi-box-arrow-right"></i> Sair
                    </button>
                </div>
            </div>
        </nav>

        <main class="container-fluid my-4">
            
            <ul class="nav nav-tabs nav-fill main-task-tabs mb-3" id="mainTasksTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="task-analysis-tab" data-bs-toggle="tab" data-bs-target="#task-analysis-pane" type="button" role="tab" aria-controls="task-analysis-pane" aria-selected="true">
                        <i class="bi bi-bar-chart-line-fill"></i> Análise de Relatórios
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="task-manager-tab" data-bs-toggle="tab" data-bs-target="#task-manager-pane" type="button" role="tab" aria-controls="task-manager-pane" aria-selected="false">
                        <i class="bi bi-people-fill"></i> Gerenciar Pessoas
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTasksTabContent">
                
                <div class="tab-pane fade show active" id="task-analysis-pane" role="tabpanel" aria-labelledby="task-analysis-tab" tabindex="0">
                    
                    <div id="analysis" class="card p-3 p-md-4 border-0 shadow-sm">
                        
                        <div class="row g-3 mb-3 p-3 bg-light border rounded">
                            <div class="col-md-5">
                                <label for="selectMes" class="form-label">Mês</label>
                                <select id="selectMes" class="form-select"></select>
                            </div>
                            <div class="col-md-5">
                                <label for="selectAno" class="form-label">Ano</label>
                                <select id="selectAno" class="form-select"></select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="loadReportsButton" class="btn btn-primary w-100">
                                    <span id="loadButtonText"><i class="bi bi-arrow-clockwise"></i> Carregar</span>
                                    <span id="loadButtonSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                                </button>
                            </div>
                        </div>
        
                        <div class="row">
                            <div class="col-lg-7">
                                <h5 class="border-bottom pb-2 mb-3">Relatório de Campo</h5>
                                
                                <ul class="nav nav-tabs" id="fieldReportTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-tab-pane" type="button" role="tab" aria-controls="overview-tab-pane" aria-selected="true">Visão Geral (Totais)</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="individual-tab" data-bs-toggle="tab" data-bs-target="#individual-tab-pane" type="button" role="tab" aria-controls="individual-tab-pane" aria-selected="false">Relatórios Enviados (Grid)</button>
                                    </li>
                                </ul>
        
                                <div class="tab-content" id="fieldReportTabsContent">
                                    
                                    <div class="tab-pane fade show active" id="overview-tab-pane" role="tabpanel" aria-labelledby="overview-tab" tabindex="0">
                                        <div class="p-3 border border-top-0 rounded-bottom">
                                            <h6 class="text-muted">Totais Agregados</h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <div class="card card-total h-100">
                                                        <div class="card-body">
                                                            <h6 class="card-title text-muted">Horas (Auxiliares)</h6>
                                                            <p class="display-6 text-primary" id="totalHorasAux">0</p>
                                                            <small id="countHorasAux">0 relataram</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <div class="card card-total h-100">
                                                        <div class="card-body">
                                                            <h6 class="card-title text-muted">Estudos (Auxiliares)</h6>
                                                            <p class="display-6 text-primary" id="totalEstudosAux">0</p>
                                                            <small id="countEstudosAux">0 relataram</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <div class="card card-total h-100">
                                                        <div class="card-body">
                                                            <h6 class="card-title text-muted">Horas (Regulares)</h6>
                                                            <p class="display-6 text-primary" id="totalHorasReg">0</p>
                                                            <small id="countHorasReg">0 relataram</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <div class="card card-total h-100">
                                                        <div class="card-body">
                                                            <h6 class="card-title text-muted">Estudos (Regulares)</h6>
                                                            <p class="display-6 text-primary" id="totalEstudosReg">0</p>
                                                            <small id="countEstudosReg">0 relataram</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <div class="card card-total h-100">
                                                        <div class="card-body">
                                                            <h6 class="card-title text-muted">Estudos (Publicadores)</h6>
                                                            <p class="display-6 text-primary" id="totalEstudosPub">0</p>
                                                            <small id="countEstudosPub">0 relataram</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
        
                                            <h6 class="text-muted mt-3">Pendentes de Relatório</h6>
                                            <div id="pendentes-body" style="max-height: 300px; overflow-y: auto;">
                                                </div>
                                        </div>
                                    </div>
                                    
                                    <div class="tab-pane fade" id="individual-tab-pane" role="tabpanel" aria-labelledby="individual-tab" tabindex="0">
                                        <div class="p-3 border border-top-0 rounded-bottom">
                                            <h6 class="text-muted">Lista de Envios Individuais</h6>
                                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                                <table class="table table-sm table-striped table-hover table-reports">
                                                    <thead>
                                                        <tr>
                                                            <th>Nome</th>
                                                            <th>Grupo</th>
                                                            <th>Horas</th>
                                                            <th>Estudos</th>
                                                            <th>Participou?</th>
                                                            <th>Observações</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="relatorios-enviados-body">
                                                        </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
        
                            <div class="col-lg-5 border-start">
                                <h5 class="border-bottom pb-2 mb-3">Relatório de Assistência</h5>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <div class="card card-total h-100">
                                            <div class="card-body">
                                                <h6 class="card-title text-muted">Meio de Semana</h6>
                                                <p class="display-6 text-success" id="totalMeioSemana">0</p>
                                                <small id="countMeioSemana">0 reuniões</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="card card-total h-100">
                                            <div class="card-body">
                                                <h6 class="card-title text-muted">Fim de Semana</h6>
                                                <p class="display-6 text-success" id="totalFimSemana">0</p>
                                                <small id="countFimSemana">0 reuniões</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
        
                                <h5 class="border-bottom pb-2 mb-3">Lista de Reuniões (Mês)</h5>
                                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Tipo</th>
                                                <th>Qtd.</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reunioes-body">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div> </div> <div class="tab-pane fade" id="task-manager-pane" role="tabpanel" aria-labelledby="task-manager-tab" tabindex="0">
                    
                    <div id="manager" class="card p-3 p-md-4 border-0 shadow-sm">
                        <h4><i class="bi bi-people-fill"></i> Gerenciar Pessoas (Lista Mestra)</h4>
                        <p>Aqui você gerencia quem pode enviar relatórios e a qual grupo pertencem.</p>
                        <form id="addPessoaForm" class="row g-3">
                            <div class="col-md-5">
                                <label for="addNome" class="form-label visually-hidden">Nome</label>
                                <input type="text" id="addNome" class="form-control" placeholder="Nome Completo" required>
                            </div>
                            <div class="col-md-4">
                                <label for="addGrupo" class="form-label visually-hidden">Grupo</label>
                                <select id="addGrupo" class="form-select" required>
                                    <option value="Publicador" selected>Publicador</option>
                                    <option value="Pioneiro Auxiliar">Pioneiro Auxiliar</option>
                                    <option value="Pioneiro Regular">Pioneiro Regular</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-plus-lg"></i> Adicionar
                                </button>
                            </div>
                        </form>
                        <hr>
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nome</th>
                                        <th>Grupo (Atual)</th>
                                        <th style="width: 180px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="pessoas-body">
                                    </tbody>
                            </table>
                        </div>
                    </div> </div> </div> </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // [PRODUÇÃO V2.3] (JS V2.1 - Sem alterações na lógica)

        // --- 1. Configuração do Firebase ---
        const firebaseConfig = {
          apiKey: "AIzaSyC2PtOb7RwgZGXP-zW3vf65AY1ivQ-eySA",
          authDomain: "relatorio-de-campo-5c837.firebaseapp.com",
          projectId: "relatorio-de-campo-5c837",
          storageBucket: "relatorio-de-campo-5c837.firebasestorage.app",
          messagingSenderId: "11198755551",
          appId: "1:11198755551:web:6c7d4ab3ff3d860c27ef6a"
        };

        // --- 2. Inicialização do Firebase ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const pessoasCol = db.collection("pessoas");
        const relatoriosCol = db.collection("relatorios");
        const reunioesCol = db.collection("reunioes");

        // --- 3. Elementos do DOM ---
        const loginContainer = document.getElementById("loginContainer");
        const dashboardContainer = document.getElementById("dashboardContainer");
        const loginForm = document.getElementById("loginForm");
        const loginError = document.getElementById("loginError");
        const loginSuccess = document.getElementById("loginSuccess");
        const forgotPasswordLink = document.getElementById("forgotPasswordLink");
        const userEmail = document.getElementById("userEmail");
        const logoutButton = document.getElementById("logoutButton");
        const addPessoaForm = document.getElementById("addPessoaForm");
        const pessoasBody = document.getElementById("pessoas-body");
        const selectMes = document.getElementById("selectMes");
        const selectAno = document.getElementById("selectAno");
        const loadReportsButton = document.getElementById("loadReportsButton");
        const loadButtonText = document.getElementById("loadButtonText");
        const loadButtonSpinner = document.getElementById("loadButtonSpinner");
        const pendentesBody = document.getElementById("pendentes-body");
        const relatoriosEnviadosBody = document.getElementById("relatorios-enviados-body");
        const reunioesBody = document.getElementById("reunioes-body");

        const nomesMeses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // =================================================================
        // 4. LÓGICA DE AUTENTICAÇÃO (Sem Alterações)
        // =================================================================

        auth.onAuthStateChanged(user => {
            if (user) {
                loginContainer.style.display = "none";
                dashboardContainer.style.display = "block";
                userEmail.textContent = user.email;
                initDashboard();
            } else {
                loginContainer.style.display = "block";
                dashboardContainer.style.display = "none";
                userEmail.textContent = "";
            }
        });

        loginForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            loginError.style.display = "none";
            loginSuccess.style.display = "none";
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    loginError.textContent = "Email ou senha inválidos. Tente novamente.";
                    loginError.style.display = "block";
                });
        });

        logoutButton.addEventListener("click", () => {
            auth.signOut();
        });

        forgotPasswordLink.addEventListener("click", (e) => {
            e.preventDefault();
            const email = document.getElementById("loginEmail").value;
            if (!email) {
                loginError.textContent = "Digite seu email no campo 'Email' para redefinir a senha.";
                loginError.style.display = "block";
                return;
            }
            loginError.style.display = "none";
            loginSuccess.style.display = "none";
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    loginSuccess.textContent = "Email de redefinição de senha enviado para " + email;
                    loginSuccess.style.display = "block";
                })
                .catch(error => {
                    loginError.textContent = "Erro ao enviar email de redefinição. Verifique o email.";
                    loginError.style.display = "block";
                });
        });

        // =================================================================
        // 5. LÓGICA DO DASHBOARD (Inicialização) (Sem Alterações)
        // =================================================================

        function initDashboard() {
            populateDateSelectors();
            loadPessoasCRUD();
            loadAllReports(); 
            addPessoaForm.addEventListener("submit", handleAddPessoa);
            loadReportsButton.addEventListener("click", loadAllReports);
        }
        
        function populateDateSelectors() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            nomesMeses.forEach((nome, index) => {
                const option = document.createElement("option");
                option.value = index; 
                option.textContent = nome;
                if (index === mesAtual) option.selected = true;
                selectMes.appendChild(option);
            });

            for (let i = anoAtual; i >= anoAtual - 3; i--) {
                const option = document.createElement("option");
                option.value = i;
                option.textContent = i;
                if (i === anoAtual) option.selected = true;
                selectAno.appendChild(option);
            }
        }

        // =================================================================
        // 6. CRUD (GERENCIAMENTO DE PESSOAS) (Sem Alterações)
        // =================================================================

        async function handleAddPessoa(e) {
            e.preventDefault();
            const nomeInput = document.getElementById("addNome");
            const grupoInput = document.getElementById("addGrupo");
            const nome = nomeInput.value.trim();
            const grupo = grupoInput.value;
            if (!nome) return;
            try {
                await pessoasCol.add({ nome: nome, grupo: grupo });
                nomeInput.value = ''; 
            } catch (error) {
                console.error("Erro ao adicionar pessoa: ", error);
                alert("Erro ao adicionar pessoa.");
            }
        }

        function loadPessoasCRUD() {
            pessoasCol.orderBy("nome").onSnapshot(snapshot => {
                pessoasBody.innerHTML = ""; 
                if (snapshot.empty) {
                    pessoasBody.innerHTML = '<tr><td colspan="3">Nenhuma pessoa cadastrada.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const pessoa = doc.data();
                    const id = doc.id;
                    const row = document.createElement("tr");
                    row.dataset.id = id; 
                    // [V2.3] HTML dos botões atualizado para o novo design
                    row.innerHTML = `
                        <td>
                            <span class="nome-text">${pessoa.nome}</span>
                            <input type="text" class="form-control form-control-sm nome-input" value="${pessoa.nome}">
                        </td>
                        <td>
                            <select class="form-select form-select-sm" onchange="window.handleUpdateGrupo('${id}', this.value)">
                                <option value="Publicador" ${pessoa.grupo === 'Publicador' ? 'selected' : ''}>Publicador</option>
                                <option value="Pioneiro Auxiliar" ${pessoa.grupo === 'Pioneiro Auxiliar' ? 'selected' : ''}>Pioneiro Auxiliar</option>
                                <option value="Pioneiro Regular" ${pessoa.grupo === 'Pioneiro Regular' ? 'selected' : ''}>Pioneiro Regular</option>
                            </select>
                        </td>
                        <td>
                            <div class="default-buttons">
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.toggleEditNome(this)">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="window.handleDeletePessoa('${id}', '${pessoa.nome}')">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                            <div class="edit-buttons">
                                <button class="btn btn-success btn-sm" onclick="window.handleUpdateNome(this, '${id}')">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="window.toggleEditNome(this, true)">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    pessoasBody.appendChild(row);
                });
            }, error => {
                console.error("Erro ao carregar pessoas (snapshot): ", error);
                alert("Erro crítico ao carregar a lista de pessoas.");
            });
        }

        window.handleUpdateGrupo = async (id, novoGrupo) => {
            try {
                await pessoasCol.doc(id).update({ grupo: novoGrupo });
            } catch (error) {
                console.error("Erro ao atualizar grupo: ", error);
            }
        };
        
        window.toggleEditNome = (button, cancel = false) => {
            const row = button.closest('tr');
            const nomeText = row.querySelector('.nome-text');
            const nomeInput = row.querySelector('.nome-input');
            const defaultButtons = row.querySelector('.default-buttons');
            const editButtons = row.querySelector('.edit-buttons');
            if (cancel) {
                nomeInput.value = nomeText.textContent;
            }
            nomeText.classList.toggle('editing');
            nomeInput.classList.toggle('editing');
            defaultButtons.classList.toggle('editing');
            editButtons.classList.toggle('editing');
        };

        window.handleUpdateNome = async (button, id) => {
            const row = button.closest('tr');
            const nomeInput = row.querySelector('.nome-input');
            const novoNome = nomeInput.value.trim();
            if (!novoNome) return;
            try {
                await pessoasCol.doc(id).update({ nome: novoNome });
                window.toggleEditNome(button, false); 
            } catch (error) {
                console.error("Erro ao atualizar nome: ", error);
            }
        };

        window.handleDeletePessoa = async (id, nome) => {
            if (confirm(`Tem certeza que deseja excluir ${nome}?`)) {
                try {
                    await pessoasCol.doc(id).delete();
                } catch (error) {
                    console.error("Erro ao excluir pessoa: ", error);
                }
            }
        };

        // =================================================================
        // 7. LÓGICA DE ANÁLISE DE RELATÓRIOS (Sem Alterações)
        // =================================================================

        function resetAnalysisUI() {
            // Cards de Campo
            ['totalHorasAux', 'totalEstudosAux', 'totalHorasReg', 'totalEstudosReg', 'totalEstudosPub'].forEach(id => {
                document.getElementById(id).textContent = '0';
            });
            ['countHorasAux', 'countEstudosAux', 'countHorasReg', 'countEstudosReg', 'countEstudosPub'].forEach(id => {
                document.getElementById(id).textContent = '0 relataram';
            });
            // Cards de Reunião
            document.getElementById('totalMeioSemana').textContent = '0';
            document.getElementById('totalFimSemana').textContent = '0';
            document.getElementById('countMeioSemana').textContent = '0 reuniões';
            document.getElementById('countFimSemana').textContent = '0 reuniões';
            
            // Tabelas
            pendentesBody.innerHTML = '<p class="text-muted">Carregando...</p>';
            reunioesBody.innerHTML = '<tr><td colspan="3" class="text-muted">Carregando...</td></tr>';
            relatoriosEnviadosBody.innerHTML = '<tr><td colspan="6" class="text-muted">Carregando...</td></tr>';
        }

        async function loadAllReports() {
            resetAnalysisUI();
            setLoadButtonLoading(true);
            
            const mesIndex = parseInt(selectMes.value); 
            const ano = parseInt(selectAno.value);
            const mesReferencia = `${nomesMeses[mesIndex]}/${ano}`;

            const startDate = new Date(ano, mesIndex, 1, 0, 0, 0);
            const endDate = new Date(ano, mesIndex + 1, 0, 23, 59, 59);

            try {
                await Promise.all([
                    loadFieldReports(mesReferencia),
                    loadMeetingReports(startDate, endDate)
                ]);
            } catch (error) {
                console.error("Erro ao carregar relatórios:", error);
            } finally {
                setLoadButtonLoading(false); 
            }
        }

        async function loadFieldReports(mesReferencia) {
            relatoriosEnviadosBody.innerHTML = ''; 
            
            try {
                const pessoasSnapshot = await pessoasCol.get();
                const allPessoas = new Map(); 
                pessoasSnapshot.forEach(doc => {
                    allPessoas.set(doc.data().nome, doc.data().grupo);
                });

                const relatoriosSnapshot = await relatoriosCol.where("mesReferencia", "==", mesReferencia).get();
                
                let totais = {
                    horasAux: 0, estudosAux: 0, countAux: 0,
                    horasReg: 0, estudosReg: 0, countReg: 0,
                    estudosPub: 0, countPub: 0
                };
                
                const nomesQueEnviaram = new Set(); 

                if (relatoriosSnapshot.empty) {
                    relatoriosEnviadosBody.innerHTML = '<tr><td colspan="6" class="text-muted">Nenhum relatório enviado para este mês.</td></tr>';
                }

                relatoriosSnapshot.forEach(doc => {
                    const rel = doc.data();
                    nomesQueEnviaram.add(rel.nome);

                    if (rel.grupo === "Pioneiro Auxiliar") {
                        totais.horasAux += (rel.horas || 0);
                        totais.estudosAux += (rel.estudos || 0);
                        totais.countAux++;
                    } else if (rel.grupo === "Pioneiro Regular") {
                        totais.horasReg += (rel.horas || 0);
                        totais.estudosReg += (rel.estudos || 0);
                        totais.countReg++;
                    } else if (rel.grupo === "Publicador") {
                        totais.estudosPub += (rel.estudos || 0);
                        if (rel.participou === "Sim" || (rel.estudos || 0) > 0) {
                            totais.countPub++; 
                        }
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rel.nome}</td>
                        <td>${rel.grupo}</td>
                        <td>${rel.horas || '—'}</td>
                        <td>${rel.estudos || 0}</td>
                        <td>${rel.participou || '—'}</td>
                        <td>${rel.observacoes || ''}</td>
                    `;
                    relatoriosEnviadosBody.appendChild(row);
                });

                document.getElementById('totalHorasAux').textContent = totais.horasAux;
                document.getElementById('totalEstudosAux').textContent = totais.estudosAux;
                document.getElementById('totalHorasReg').textContent = totais.horasReg;
                document.getElementById('totalEstudosReg').textContent = totais.estudosReg;
                document.getElementById('totalEstudosPub').textContent = totais.estudosPub;
                
                document.getElementById('countHorasAux').textContent = `${totais.countAux} relataram`;
                document.getElementById('countEstudosAux').textContent = `${totais.countAux} relataram`;
                document.getElementById('countHorasReg').textContent = `${totais.countReg} relataram`;
                document.getElementById('countEstudosReg').textContent = `${totais.countReg} relataram`;
                document.getElementById('countEstudosPub').textContent = `${totais.countPub} relataram`;
                
                renderPendentes(allPessoas, nomesQueEnviaram);

            } catch (error) {
                console.error("Erro ao carregar relatórios de campo: ", error);
                pendentesBody.innerHTML = '<p class="text-danger">Erro ao carregar pendentes.</p>';
                relatoriosEnviadosBody.innerHTML = '<tr><td colspan="6" class="text-danger">Erro ao carregar relatórios.</td></tr>';
            }
        }
        
        function renderPendentes(allPessoas, nomesQueEnviaram) {
            const pendentes = {
                "Publicador": [],
                "Pioneiro Auxiliar": [],
                "Pioneiro Regular": []
            };

            allPessoas.forEach((grupo, nome) => {
                if (!nomesQueEnviaram.has(nome)) {
                    if (pendentes.hasOwnProperty(grupo)) {
                        pendentes[grupo].push(nome);
                    }
                }
            });

            pendentesBody.innerHTML = ''; 
            let totalPendentes = 0;
            const gruposParaExibir = ["Pioneiro Regular", "Pioneiro Auxiliar", "Publicador"];
            
            gruposParaExibir.forEach(grupo => {
                const lista = pendentes[grupo];
                if (lista.length > 0) {
                    totalPendentes += lista.length;
                    let html = `<h6 class="text-muted">${grupo} (${lista.length})</h6><ul class="list-group list-group-flush mb-3">`;
                    lista.sort().forEach(nome => { 
                        html += `<li class="list-group-item py-1">${nome}</li>`;
                    });
                    html += `</ul>`;
                    pendentesBody.innerHTML += html;
                }
            });
            
            if (totalPendentes === 0) {
                pendentesBody.innerHTML = '<p class="text-success">Todos enviaram o relatório!</p>';
            }
        }

        async function loadMeetingReports(startDate, endDate) {
            reunioesBody.innerHTML = '';
            try {
                const startTimestamp = firebase.firestore.Timestamp.fromDate(startDate);
                const endTimestamp = firebase.firestore.Timestamp.fromDate(endDate);

                const q = reunioesCol
                    .where("dataTimestamp", ">=", startTimestamp)
                    .where("dataTimestamp", "<=", endTimestamp)
                    .orderBy("dataTimestamp", "asc");

                const snapshot = await q.get();

                let totalMeioSemana = 0;
                let countMeioSemana = 0;
                let totalFimSemana = 0;
                let countFimSemana = 0;

                if (snapshot.empty) {
                    reunioesBody.innerHTML = '<tr><td colspan="3" class="text-muted">Nenhuma reunião encontrada.</td></tr>';
                }

                snapshot.forEach(doc => {
                    const reuniao = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${reuniao.data}</td>
                        <td>${reuniao.tipo}</td>
                        <td><strong>${reuniao.quantidade}</strong></td>
                    `;
                    reunioesBody.appendChild(row);

                    if (reuniao.tipo === "Meio de Semana") {
                        totalMeioSemana += reuniao.quantidade;
                        countMeioSemana++;
                    } else if (reuniao.tipo === "Fim de Semana") {
                        totalFimSemana += reuniao.quantidade;
                        countFimSemana++;
                    }
                });

                document.getElementById('totalMeioSemana').textContent = totalMeioSemana;
                document.getElementById('totalFimSemana').textContent = totalFimSemana;
                document.getElementById('countMeioSemana').textContent = `${countMeioSemana} reuniões`;
                document.getElementById('countFimSemana').textContent = `${countFimSemana} reuniões`;

            } catch (error) {
                console.error("Erro ao carregar relatórios de reunião: ", error);
                reunioesBody.innerHTML = '<tr><td colspan="3" class="text-danger">Erro ao carregar lista.</td></tr>';
            }
        }

        function setLoadButtonLoading(isLoading) {
            if (isLoading) {
                loadReportsButton.disabled = true;
                loadButtonText.style.display = 'none';
                loadButtonSpinner.style.display = 'inline-block';
            } else {
                loadReportsButton.disabled = false;
                loadButtonText.style.display = 'inline-block';
                loadButtonSpinner.style.display = 'none';
            }
        }

    </script>
</body>
</html>
